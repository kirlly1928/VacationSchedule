<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График отпусков сотрудников</title>
    <script src="https://cdn.tailwindcss.com "></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter :wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Ваши стили без изменений */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .table-header th { background-color: #e5e7eb; }
        .btn {
            transition: background-color 0.3s ease;
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }

        /* Остальные стили — как у вас */
        /* ... (оставляем все ваши стили) */
    </style>
</head>
<body class="bg-gray-100">

<div class="container">
    <!-- Ваш HTML без изменений -->
    <!-- Форма, таблица, календарь и модальное окно удаления -->
    <!-- ... (ваш HTML содержимое без изменений) -->
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js "></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js "></script>

<script>
    // Инициализация Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCS8kdoT-6msPuErRXYPYeP2PxTqzNKV6A",
        authDomain: "vacation-d2585.firebaseapp.com",
        databaseURL: "https://vacation-d2585.firebaseio.com ",
        projectId: "vacation-d2585",
        storageBucket: "vacation-d2585.firebasestorage.app",
        messagingSenderId: "1026454413781",
        appId: "1:1026454413781:web:dad360421616ee782c9d5c",
        measurementId: "G-9ZCD95E2F7"
    };

    // Инициализируем Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let vacations = [];
    let vacationToDeleteIndex = null;

    // Слушаем изменения в Firebase
    database.ref('vacations').on('value', (snapshot) => {
        if (snapshot.exists()) {
            vacations = Object.values(snapshot.val());
        } else {
            vacations = [];
        }
        applyAllFilters(); // перерисовываем таблицу и календарь
    });

    // Элементы DOM
    const form = document.getElementById('addVacationForm');
    const vacationList = document.getElementById('vacationList');
    const formError = document.getElementById('formError');
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const closeModalButton = document.getElementById('closeModalButton');
    const cancelDeleteButton = document.getElementById('cancelDeleteButton');
    const confirmDeleteButtonAction = document.getElementById('confirmDeleteButtonAction');
    const filterMonthSelect = document.getElementById('filterMonth');
    const filterYearInput = document.getElementById('filterYear');
    const applyFiltersButton = document.getElementById('applyFilters');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const noCalendarResultsMessage = document.getElementById('noCalendarResultsMessage');
    const timelineView = document.getElementById('timelineView');
    const monthHeaderContainer = document.getElementById('monthHeaderContainer');

    const MS_PER_DAY = 1000 * 60 * 60 * 24;

    // Функция для расчета разницы в днях
    function dateDiffInDays(date1Str, date2Str) {
        const date1 = new Date(date1Str);
        const date2 = new Date(date2Str);
        if (isNaN(date1) || isNaN(date2)) return 0;
        const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.floor((utc2 - utc1) / MS_PER_DAY) + 1;
    }

    // Форматирование даты
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    // Рендеринг таблицы
    function renderVacations(filteredVacations = vacations) {
        vacationList.innerHTML = '';
        if (filteredVacations.length === 0) {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none';
        }
        filteredVacations.forEach((vacation, index) => {
            const duration = dateDiffInDays(vacation.start, vacation.end);
            const row = `
                <tr id="vacation-${index}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${vacation.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(vacation.start)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(vacation.end)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${duration}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openDeleteModal(${index})" class="btn btn-danger px-3 py-1 rounded-md text-xs">Удалить</button>
                    </td>
                </tr>`;
            vacationList.insertAdjacentHTML('beforeend', row);
        });
    }

    // Рендер календаря
    function renderCalendarView(filteredVacations = vacations) {
        timelineView.innerHTML = '';
        monthHeaderContainer.innerHTML = '';
        if (filteredVacations.length === 0) {
            noCalendarResultsMessage.style.display = 'block';
            return;
        }
        noCalendarResultsMessage.style.display = 'none';

        let minDate = new Date();
        let maxDate = new Date(minDate.getFullYear(), minDate.getMonth() + 2, 0);

        if (filteredVacations.length > 0) {
            minDate = new Date(Math.min(...filteredVacations.map(v => new Date(v.start).getTime())));
            maxDate = new Date(Math.max(...filteredVacations.map(v => new Date(v.end).getTime())));
        }

        const yearFilter = filterYearInput.value ? parseInt(filterYearInput.value) : null;
        const monthFilter = filterMonthSelect.value ? parseInt(filterMonthSelect.value) : null;

        if (yearFilter && monthFilter === null) {
            minDate = new Date(yearFilter, 0, 1);
            maxDate = new Date(yearFilter, 11, 31);
        } else if (yearFilter && monthFilter !== null) {
            minDate = new Date(yearFilter, monthFilter, 1);
            maxDate = new Date(yearFilter, monthFilter + 1, 0);
        } else if (!yearFilter && monthFilter !== null) {
            const currentYear = new Date().getFullYear();
            minDate = new Date(currentYear, monthFilter, 1);
            maxDate = new Date(currentYear, monthFilter + 1, 0);
        }

        const totalDaysInRange = dateDiffInDays(minDate, maxDate);
        if (totalDaysInRange <= 0) {
            noCalendarResultsMessage.style.display = 'block';
            timelineView.innerHTML = '<p class="text-center text-gray-500">Некорректный диапазон дат для календаря.</p>';
            return;
        }

        const dayWidthPercentage = 100 / totalDaysInRange;

        // Месяцы в заголовке
        let currentMonth = new Date(minDate);
        while (currentMonth <= maxDate) {
            const monthName = currentMonth.toLocaleString('ru-RU', { month: 'long' });
            const year = currentMonth.getFullYear();
            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            let daysVisibleInThisMonth = 0;
            for (let i = 0; i < daysInMonth; i++) {
                const day = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), currentMonth.getDate() + i);
                if (day >= minDate && day <= maxDate) daysVisibleInThisMonth++;
            }
            if (daysVisibleInThisMonth > 0) {
                const monthHeader = document.createElement('div');
                monthHeader.classList.add('month-header');
                monthHeader.textContent = `${monthName} ${year}`;
                monthHeader.style.width = `${daysVisibleInThisMonth * dayWidthPercentage}%`;
                monthHeaderContainer.appendChild(monthHeader);
            }
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            currentMonth.setDate(1);
        }

        // Группировка по сотрудникам
        const vacationsByEmployee = filteredVacations.reduce((acc, vacation) => {
            if (!acc[vacation.name]) acc[vacation.name] = [];
            acc[vacation.name].push(vacation);
            return acc;
        }, {});

        for (const employeeName in vacationsByEmployee) {
            const employeeTimeline = document.createElement('div');
            employeeTimeline.classList.add('employee-timeline');
            const nameDiv = document.createElement('div');
            nameDiv.classList.add('employee-name-calendar');
            nameDiv.textContent = employeeName;
            employeeTimeline.appendChild(nameDiv);
            const daysContainer = document.createElement('div');
            daysContainer.classList.add('days-container');

            vacationsByEmployee[employeeName].forEach(vacation => {
                const vacStart = new Date(vacation.start);
                const vacEnd = new Date(vacation.end);
                const displayStart = new Date(Math.max(vacStart, minDate));
                const displayEnd = new Date(Math.min(vacEnd, maxDate));
                if (displayStart <= displayEnd) {
                    const offsetDays = dateDiffInDays(minDate, displayStart) - 1;
                    const durationInView = dateDiffInDays(displayStart, displayEnd);
                    const dayBlock = document.createElement('div');
                    dayBlock.classList.add('day-block');
                    dayBlock.style.left = `${offsetDays * dayWidthPercentage}%`;
                    dayBlock.style.width = `${durationInView * dayWidthPercentage}%`;
                    if (durationInView * dayWidthPercentage > 5) {
                        dayBlock.textContent = `Отпуск`;
                    }
                    daysContainer.appendChild(dayBlock);
                }
            });

            employeeTimeline.appendChild(daysContainer);
            timelineView.appendChild(employeeTimeline);
        }
    }

    // Обработчик формы
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        formError.textContent = '';
        const name = form.employeeName.value.trim();
        const start = form.vacationStart.value;
        const end = form.vacationEnd.value;
        if (!name || !start || !end) {
            formError.textContent = 'Все поля обязательны для заполнения.';
            return;
        }
        const startDate = new Date(start);
        const endDate = new Date(end);
        if (endDate < startDate) {
            formError.textContent = 'Дата окончания не может быть раньше начала.';
            return;
        }

        const overlappingVacation = vacations.find(v =>
            v.name === name &&
            !(endDate < new Date(v.start) || startDate > new Date(v.end))
        );
        if (overlappingVacation) {
            formError.textContent = `У "${name}" уже есть отпуск с ${formatDate(overlappingVacation.start)} по ${formatDate(overlappingVacation.end)}.`;
            return;
        }

        database.ref('vacations').push({ name, start, end }).then(() => {
            console.log("Отпуск успешно добавлен в Firebase");
            form.reset();
        });
    });

    // Модальное окно удаления
    function openDeleteModal(index) {
        vacationToDeleteIndex = index;
        confirmDeleteModal.style.display = 'block';
    }

    function closeDeleteModal() {
        confirmDeleteModal.style.display = 'none';
        vacationToDeleteIndex = null;
    }

    closeModalButton.onclick = closeDeleteModal;
    cancelDeleteButton.onclick = closeDeleteModal;
    window.onclick = function(event) {
        if (event.target == confirmDeleteModal) closeDeleteModal();
    }

    confirmDeleteButtonAction.onclick = function() {
        if (vacationToDeleteIndex !== null) {
            const vacationKeys = Object.keys(vacations);
            const keyToRemove = vacationKeys[vacationToDeleteIndex];
            database.ref('vacations/' + keyToRemove).remove().then(() => {
                console.log("Отпуск удален из Firebase");
                closeDeleteModal();
            });
        }
    }

    // Фильтры
    function populateFilterOptions() {
        const currentMonthValue = filterMonthSelect.value;
        filterMonthSelect.innerHTML = '<option value="">Все месяцы</option>';
        const months = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            filterMonthSelect.appendChild(option);
        });
        filterMonthSelect.value = currentMonthValue;
    }

    function applyAllFilters() {
        const monthFilter = filterMonthSelect.value;
        const yearFilter = filterYearInput.value;
        let filtered = vacations;

        if (yearFilter) {
            filtered = filtered.filter(v => {
                const startYear = new Date(v.start).getFullYear();
                const endYear = new Date(v.end).getFullYear();
                return startYear === parseInt(yearFilter) || endYear === parseInt(yearFilter);
            });
        }

        if (monthFilter !== "") {
            filtered = filtered.filter(v => {
                const vacStart = new Date(v.start);
                const vacEnd = new Date(v.end);
                const filterMonthDateStart = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter), 1);
                const filterMonthDateEnd = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter) + 1, 0);
                return (vacStart <= filterMonthDateEnd && vacEnd >= filterMonthDateStart);
            });
        }

        renderVacations(filtered);
        renderCalendarView(filtered);
    }

    applyFiltersButton.addEventListener('click', applyAllFilters);

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
        populateFilterOptions();
        const currentYear = new Date().getFullYear();
        filterYearInput.value = currentYear;
        applyAllFilters();
    });
</script>
</body>
</html>
