<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График отпусков сотрудников</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Светло-серый фон */
        }
        .container {
            max-width: 1000px; /* Увеличена максимальная ширина для лучшего отображения таблицы */
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem; /* Закругленные углы */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .table-header th {
            background-color: #e5e7eb; /* Фон заголовков таблицы */
        }
        .btn {
            transition: background-color 0.3s ease;
            cursor: pointer; /* Убедимся, что курсор меняется на указатель */
            pointer-events: auto; /* Убедимся, что клики регистрируются */
        }
        .btn-primary {
            background-color: #3b82f6; /* Синий */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: #ef4444; /* Красный */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #22c55e; /* Зеленый */
            color: white;
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .modal {
            display: none; /* Скрыто по умолчанию */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            position: relative; /* Для z-index */
            z-index: 51; /* Выше, чем фон модального окна */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Стили для визуализации календаря */
        .calendar-view {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            overflow-x: auto; /* Горизонтальная прокрутка для календаря */
        }
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Пространство между сотрудниками */
        }
        .employee-timeline {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .employee-name-calendar {
            width: 150px; /* Фиксированная ширина для имени сотрудника */
            min-width: 100px; /* Минимальная ширина для адаптивности */
            font-weight: 500;
            padding-right: 1rem;
            flex-shrink: 0; /* Предотвращает сжатие имени */
        }
        .days-container {
            display: flex;
            flex-grow: 1; /* Занимает оставшееся пространство */
            position: relative; /* Для позиционирования отпускных блоков */
            height: 30px; /* Высота полосы для дней */
            background-color: #e5e7eb; /* Фон для полосы дней */
            border-radius: 0.25rem;
        }
        .day-block {
            position: absolute; /* Позиционирование относительно days-container */
            height: 100%;
            background-color: #60a5fa; /* Синий цвет для отпуска по умолчанию */
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            opacity: 0.8;
            overflow: hidden; /* Обрезать текст, если не помещается */
            white-space: nowrap; /* Запретить перенос текста */
        }
        .day-block.brigade {
            background-color: #34d399; /* Изумрудный цвет для бригад (emerald-400) */
        }
        .month-header-container {
            display: flex;
            margin-bottom: 0.5rem;
            padding-left: 166px; /* 150px (имя) + 1rem (отступ) */
        }
        .month-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            border-right: 1px solid #d1d5db; /* Разделитель между месяцами */
            height: 30px;
        }
        .month-header:last-child {
            border-right: none;
        }
        .days-of-month-row {
            display: flex;
            margin-bottom: 0.5rem;
            padding-left: 166px; /* Совпадает с отступом для имен */
        }
        .day-of-month-cell {
            text-align: center;
            font-size: 0.7rem;
            color: #6b7280;
            flex-shrink: 0;
            box-sizing: border-box;
            border-right: 1px dashed #d1d5db; /* Пунктирная линия для дней */
        }
        .day-of-month-cell:last-child {
            border-right: none;
        }
        /* Стили для списка сотрудников */
        #officeEmployeesList ul {
            list-style: none;
            padding: 0;
        }
        #officeEmployeesList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        #officeEmployeesList li:last-child {
            border-bottom: none;
        }

        /* Адаптивность для мобильных устройств (портретная ориентация) */
        @media (max-width: 767px) and (orientation: portrait) {
            .employee-name-calendar {
                width: 100px; /* Уменьшаем ширину для имен на мобильных */
                min-width: 80px;
                padding-right: 0.25rem;
            }

            .month-header-container,
            .days-of-month-row {
                padding-left: 108px; /* 100px (employee-name) + 0.5rem (8px) */
            }

            .month-header {
                writing-mode: vertical-lr; /* Текст вертикально */
                text-orientation: mixed; /* Символы остаются вертикальными */
                width: 30px; /* Фиксированная ширина для вертикального заголовка */
                height: auto; /* Высота подстраивается под содержимое */
                padding: 0.25rem 0.1rem; /* Уменьшаем отступы */
                font-size: 0.65rem; /* Уменьшаем шрифт */
                border-right: none; /* Убираем вертикальный разделитель */
                border-bottom: 1px solid #d1d5db; /* Добавляем горизонтальный разделитель */
            }
            .month-header:last-child {
                border-bottom: none;
            }
            .month-header:first-child {
                border-left: none; /* Убираем левый разделитель, если он есть */
            }

            .day-of-month-cell {
                font-size: 0.6rem; /* Уменьшаем шрифт для чисел дней */
                writing-mode: vertical-lr; /* Числа вертикально */
                text-orientation: mixed; /* Символы остаются вертикальными */
                width: 20px; /* Уменьшаем ширину для вертикальных чисел */
                height: auto; /* Высота подстраивается под содержимое */
                padding: 0.1rem; /* Уменьшаем отступы */
                border-right: none; /* Убираем вертикальный разделитель */
                border-bottom: 1px dashed #d1d5db; /* Добавляем горизонтальный разделитель */
            }
            .day-of-month-cell:last-child {
                border-bottom: none;
            }

            /* Для форм, чтобы они лучше выглядели на мобильных */
            .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: 1fr; /* Одна колонка на мобильных */
            }
            .flex.flex-col.sm\:flex-row.gap-4.items-end.mb-4,
            .flex.flex-col.sm\:flex-row.gap-4.items-center {
                flex-direction: column; /* Элементы в колонку */
                align-items: stretch; /* Растягиваем элементы */
            }
            .w-full.sm\:w-auto {
                width: 100%; /* Элементы занимают всю ширину */
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container" id="content-to-export">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-700">График отпусков сотрудников и бригад</h1>

        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Управление сотрудниками офиса</h2>
            <form id="addOfficeEmployeeForm" class="flex flex-col sm:flex-row gap-4 items-end mb-4">
                <div class="flex-grow w-full sm:w-auto">
                    <label for="newOfficeEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Имя нового сотрудника:</label>
                    <input type="text" id="newOfficeEmployeeName" name="newOfficeEmployeeName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="btn btn-primary py-2 px-4 rounded-md shadow-sm w-full sm:w-auto">Добавить</button>
            </form>
            <p id="employeeFormError" class="text-red-500 text-sm mt-2"></p>

            <div id="officeEmployeesList" class="mt-4">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Список сотрудников офиса:</h3>
                <ul>
                    </ul>
                <p id="noOfficeEmployeesMessage" class="text-center text-gray-500 mt-4" style="display: none;">Список сотрудников пуст.</p>
            </div>
        </div>

        <form id="addVacationForm" class="mb-8 p-6 bg-gray-50 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Добавить отпуск</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="entityType" class="block text-sm font-medium text-gray-700 mb-1">Тип:</label>
                    <select id="entityType" name="entityType" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Выберите тип</option>
                        <option value="employee">Сотрудник офиса</option>
                        <option value="brigade">Бригада цеха</option>
                    </select>
                </div>
                <div id="officeEmployeeSelectContainer" class="w-full" style="display: none;">
                    <label for="officeEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Сотрудник офиса:</label>
                    <select id="officeEmployeeName" name="officeEmployeeName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Выберите сотрудника</option>
                    </select>
                </div>
                <div id="brigadeSelectContainer" class="w-full" style="display: none;">
                    <label for="brigadeName" class="block text-sm font-medium text-gray-700 mb-1">Бригада цеха:</label>
                    <select id="brigadeName" name="brigadeName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Выберите бригаду</option>
                        <option value="Р1">Р1</option>
                        <option value="Р2">Р2</option>
                        <option value="Р3">Р3</option>
                        <option value="Р4">Р4</option>
                        <option value="Р5">Р5</option>
                        <option value="Р6">Р6</option>
                        <option value="Р7">Р7</option>
                        <option value="Р8">Р8</option>
                    </select>
                </div>
                <div>
                    <label for="vacationStart" class="block text-sm font-medium text-gray-700 mb-1">Начало отпуска:</label>
                    <input type="date" id="vacationStart" name="vacationStart" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="vacationEnd" class="block text-sm font-medium text-gray-700 mb-1">Конец отпуска:</label>
                    <input type="date" id="vacationEnd" name="vacationEnd" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-end w-full">
                    <button type="submit" class="btn btn-primary w-full py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Добавить отпуск
                    </button>
                </div>
            </div>
            <p id="formError" class="text-red-500 text-sm mt-2"></p>
        </form>

        <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
            <div class="w-full sm:w-auto">
                <label for="filterMonth" class="block text-sm font-medium text-gray-700 mb-1">Фильтр по месяцу:</label>
                <select id="filterMonth" class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Все месяцы</option>
                    </select>
            </div>
            <div class="w-full sm:w-auto">
                <label for="filterYear" class="block text-sm font-medium text-gray-700 mb-1">Фильтр по году:</label>
                <input type="number" id="filterYear" placeholder="Год (напр. 2024)"
                       class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
             <button id="applyFilters" class="btn btn-primary mt-3 sm:mt-0 sm:self-end py-2 px-4 rounded-md shadow-sm w-full sm:w-auto">Применить фильтры</button>
             <button id="exportXlsButton" class="btn btn-success mt-3 sm:mt-0 sm:self-end py-2 px-4 rounded-md shadow-sm w-full sm:w-auto">Экспорт в XLS</button>
        </div>


        <div class="overflow-x-auto bg-white shadow rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="table-header">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя/Бригада</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тип</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Начало отпуска</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Конец отпуска</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Длительность (дни)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                    </tr>
                </thead>
                <tbody id="vacationList" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
         <p id="noResultsMessage" class="text-center text-gray-500 mt-4" style="display: none;">Нет данных для отображения с учетом выбранных фильтров.</p>

        <div class="calendar-view">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Календарь отпусков</h2>
            <div id="monthHeaderContainer" class="month-header-container">
                </div>
            <div id="daysOfMonthRow" class="days-of-month-row" style="display: none;">
                </div>
            <div id="timelineView" class="timeline">
                </div>
             <p id="noCalendarResultsMessage" class="text-center text-gray-500 mt-4" style="display: none;">Нет данных для отображения в календаре с учетом выбранных фильтров.</p>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalButton">&times;</span>
            <h2 class="text-lg font-semibold mb-4">Подтверждение удаления отпуска</h2>
            <p>Вы уверены, что хотите удалить этот отпуск?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelDeleteButton" class="btn px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Отмена</button>
                <button id="confirmDeleteButtonAction" class="btn btn-danger px-4 py-2 rounded-md">Удалить</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteEmployeeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEmployeeModalButton">&times;</span>
            <h2 class="text-lg font-semibold mb-4">Подтверждение удаления сотрудника</h2>
            <p>Вы уверены, что хотите удалить сотрудника "<span id="employeeToDeleteName"></span>" и ВСЕ его отпуска?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelDeleteEmployeeButton" class="btn px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Отмена</button>
                <button id="confirmDeleteEmployeeButtonAction" class="btn btn-danger px-4 py-2 rounded-md">Удалить</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // КОНФИГУРАЦИЯ FIREBASE: Ваши данные
        const firebaseConfig = {
            apiKey: "AIzaSyCS8kdoT-6msPuErRXYPYeP2PxTqzNKV6A",
            authDomain: "vacation-d2585.firebaseapp.com",
            projectId: "vacation-d2585",
            storageBucket: "vacation-d2585.firebasestorage.app",
            messagingSenderId: "1026454413781",
            appId: "1:1026454413781:web:dad360421616ee782c9d5c",
            measurementId: "G-9ZCD95E2F7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const vacationsCollection = collection(db, "vacations");
        const officeEmployeesCollection = collection(db, "officeEmployees");

        let vacations = []; // Все отпуска, загруженные из Firestore
        let officeEmployees = []; // Все сотрудники офиса, загруженные из Firestore
        let vacationToDeleteId = null; // ID отпуска для удаления
        let employeeToDeleteId = null; // ID сотрудника для удаления
        let employeeToDeleteName = ''; // Имя сотрудника для отображения в модальном окне

        // Элементы DOM - общие
        const form = document.getElementById('addVacationForm');
        const formError = document.getElementById('formError');
        const vacationList = document.getElementById('vacationList');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const noCalendarResultsMessage = document.getElementById('noCalendarResultsMessage');
        const timelineView = document.getElementById('timelineView');
        const monthHeaderContainer = document.getElementById('monthHeaderContainer');
        const daysOfMonthRow = document.getElementById('daysOfMonthRow');
        const exportXlsButton = document.getElementById('exportXlsButton'); // Кнопка экспорта в XLS

        // Элементы DOM - модальное окно отпуска
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButtonAction = document.getElementById('confirmDeleteButtonAction');

        // Элементы DOM - модальное окно сотрудника
        const confirmDeleteEmployeeModal = document.getElementById('confirmDeleteEmployeeModal');
        const closeEmployeeModalButton = document.getElementById('closeEmployeeModalButton');
        const cancelDeleteEmployeeButton = document.getElementById('cancelDeleteEmployeeButton');
        const confirmDeleteEmployeeButtonAction = document.getElementById('confirmDeleteEmployeeButtonAction');
        const employeeToDeleteNameSpan = document.getElementById('employeeToDeleteName');


        // Элементы DOM - сотрудники офиса
        const addOfficeEmployeeForm = document.getElementById('addOfficeEmployeeForm');
        const newOfficeEmployeeNameInput = document.getElementById('newOfficeEmployeeName');
        const employeeFormError = document.getElementById('employeeFormError');
        const officeEmployeesList = document.getElementById('officeEmployeesList').querySelector('ul');
        const noOfficeEmployeesMessage = document.getElementById('noOfficeEmployeesMessage');

        // Элементы DOM - добавление отпуска
        const entityTypeSelect = document.getElementById('entityType');
        const officeEmployeeSelectContainer = document.getElementById('officeEmployeeSelectContainer');
        const officeEmployeeNameSelect = document.getElementById('officeEmployeeName');
        const brigadeSelectContainer = document.getElementById('brigadeSelectContainer');
        const brigadeNameSelect = document.getElementById('brigadeName');

        // Элементы DOM - фильтры
        const filterMonthSelect = document.getElementById('filterMonth');
        const filterYearInput = document.getElementById('filterYear');
        const applyFiltersButton = document.getElementById('applyFilters');

        const MS_PER_DAY = 1000 * 60 * 60 * 24; // Миллисекунд в дне

        // Вспомогательная функция для расчета разницы в днях
        function dateDiffInDays(date1, date2) {
            // Переводим в UTC для корректного расчета дней без учета часового пояса
            const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.floor((utc2 - utc1) / MS_PER_DAY) + 1; // +1 чтобы включить оба дня
        }

        // Вспомогательная функция для форматирования даты (дд.мм.гггг)
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) { // Проверка на валидность даты
                return dateStr;
            }
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Месяцы начинаются с 0
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // --- ГЛОБАЛЬНЫЕ ФУНКЦИИ для ONCLICK в HTML ---
        // Эти функции должны быть в глобальной области видимости (window)
        // чтобы onclick в HTML мог их найти.
        window.openDeleteModal = function(id) {
            vacationToDeleteId = id;
            confirmDeleteModal.style.display = 'block';
        };

        window.openDeleteEmployeeModal = function(id, name) {
            employeeToDeleteId = id;
            employeeToDeleteName = name;
            employeeToDeleteNameSpan.textContent = name;
            confirmDeleteEmployeeModal.style.display = 'block';
        };


        // --- Функции для сотрудников офиса ---
        // Загружает список сотрудников офиса из Firestore
        async function fetchOfficeEmployees() {
            try {
                const querySnapshot = await getDocs(query(officeEmployeesCollection, orderBy('name')));
                officeEmployees = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateOfficeEmployeeSelect(); // Обновляет выпадающий список
                renderOfficeEmployeesList(); // Обновляет список для управления
            } catch (e) {
                console.error("Ошибка при загрузке сотрудников офиса: ", e);
            }
        }

        // Заполняет выпадающий список сотрудников офиса
        function populateOfficeEmployeeSelect() {
            officeEmployeeNameSelect.innerHTML = '<option value="">Выберите сотрудника</option>';
            officeEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = emp.name;
                officeEmployeeNameSelect.appendChild(option);
            });
        }

        // Рендерит список сотрудников офиса с кнопками удаления
        function renderOfficeEmployeesList() {
            officeEmployeesList.innerHTML = '';
            if (officeEmployees.length === 0) {
                noOfficeEmployeesMessage.style.display = 'block';
            } else {
                noOfficeEmployeesMessage.style.display = 'none';
                officeEmployees.forEach(emp => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>${emp.name}</span>
                        <button onclick="openDeleteEmployeeModal('${emp.id}', '${emp.name}')" class="btn btn-danger px-2 py-1 rounded-md text-xs">Удалить</button>
                    `;
                    officeEmployeesList.appendChild(listItem);
                });
            }
        }

        // Обработчик формы добавления нового сотрудника офиса
        addOfficeEmployeeForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            employeeFormError.textContent = ''; // Очищаем ошибки
            const newEmployeeName = newOfficeEmployeeNameInput.value.trim();

            if (!newEmployeeName) {
                employeeFormError.textContent = 'Имя сотрудника не может быть пустым.';
                return;
            }

            // Проверка на дубликаты
            if (officeEmployees.some(emp => emp.name === newEmployeeName)) {
                employeeFormError.textContent = `Сотрудник "${newEmployeeName}" уже существует.`;
                return;
            }

            try {
                await addDoc(officeEmployeesCollection, { name: newEmployeeName });
                newOfficeEmployeeNameInput.value = ''; // Очищаем поле ввода
                await fetchOfficeEmployees(); // Обновляем список сотрудников
            } catch (e) {
                console.error("Ошибка при добавлении сотрудника: ", e);
                employeeFormError.textContent = "Ошибка при добавлении сотрудника. Пожалуйста, попробуйте еще раз.";
            }
        });

        // --- Удаление сотрудника и его отпусков ---
        // Удаляет сотрудника и все его отпуска из Firestore
        async function deleteEmployeeAndTheirVacations(employeeId, employeeName) {
            const batch = db.batch(); // Инициализация батча для атомарных операций

            // 1. Удаляем сам документ сотрудника
            const employeeDocRef = doc(db, "officeEmployees", employeeId);
            batch.delete(employeeDocRef);

            // 2. Находим все отпуска этого сотрудника и добавляем их в батч для удаления
            const q = query(vacationsCollection, where("name", "==", employeeName), where("type", "==", "employee"));
            const vacationsSnapshot = await getDocs(q);

            vacationsSnapshot.forEach((vacDoc) => {
                batch.delete(vacDoc.ref);
            });

            try {
                await batch.commit(); // Выполняем все операции в батче
                console.log(`Сотрудник ${employeeName} и все его отпуска успешно удалены.`);
                await fetchOfficeEmployees(); // Обновляем список сотрудников
                await fetchVacations(); // Обновляем список отпусков
            } catch (e) {
                console.error("Ошибка при удалении сотрудника и его отпусков: ", e);
                alert("Ошибка при удалении сотрудника и его отпусков. Пожалуйста, попробуйте еще раз.");
            }
        }


        // --- Логика переключения полей выбора (Сотрудник/Бригада) ---
        entityTypeSelect.addEventListener('change', function() {
            if (this.value === 'employee') {
                officeEmployeeSelectContainer.style.display = 'block';
                brigadeSelectContainer.style.display = 'none';
                officeEmployeeNameSelect.setAttribute('required', 'required'); // Делаем поле обязательным
                brigadeNameSelect.removeAttribute('required'); // Убираем обязательность
            } else if (this.value === 'brigade') {
                officeEmployeeSelectContainer.style.display = 'none';
                brigadeSelectContainer.style.display = 'block';
                brigadeNameSelect.setAttribute('required', 'required');
                officeEmployeeNameSelect.removeAttribute('required');
            } else {
                // Если ничего не выбрано
                officeEmployeeSelectContainer.style.display = 'none';
                brigadeSelectContainer.style.display = 'none';
                officeEmployeeNameSelect.removeAttribute('required');
                brigadeNameSelect.removeAttribute('required');
            }
        });


        // --- Функции для взаимодействия с Firestore (Отпуска) ---
        // Загружает все отпуска из Firestore и сортирует их по дате начала
        async function fetchVacations() {
            try {
                // Запрос с сортировкой по дате начала отпуска
                const q = query(vacationsCollection, orderBy("start"));
                const querySnapshot = await getDocs(q);
                vacations = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyAllFilters(); // Применяем фильтры после загрузки всех данных
            }
            catch (e) {
                console.error("Ошибка при загрузке отпусков из Firestore: ", e);
                formError.textContent = "Ошибка при загрузке данных. Пожалуйста, попробуйте еще раз.";
            }
        }

        // Функция для проверки пересечения дат отпусков
        function checkOverlap(newName, newType, newStart, newEnd) {
            const newStartDate = new Date(newStart);
            const newEndDate = new Date(newEnd);
            let hasStrictOverlap = false; // Пересечение с ТЕМ ЖЕ сотрудником/бригадой (ошибка)
            let hasGroupOverlap = false;  // Пересечение с ДРУГИМ сотрудником/бригадой в ТОЙ ЖЕ группе (предупреждение)
            let overlappingGroupNames = []; // Имена тех, с кем есть пересечение в группе

            vacations.forEach(v => {
                const existingStartDate = new Date(v.start);
                const existingEndDate = new Date(v.end);

                // Проверяем, пересекаются ли интервалы
                const isOverlap = (newStartDate <= existingEndDate && newEndDate >= existingStartDate);

                if (isOverlap) {
                    if (v.name === newName && v.type === newType) {
                        // Отпуск для того же сотрудника/бригады на пересекающиеся даты
                        hasStrictOverlap = true;
                    } else if (v.type === newType && v.name !== newName) {
                        // Отпуск для другого сотрудника/бригады того же типа на пересекающиеся даты
                        hasGroupOverlap = true;
                        if (!overlappingGroupNames.includes(v.name)) {
                            overlappingGroupNames.push(v.name);
                        }
                    }
                }
            });

            return {
                hasStrictOverlap,
                hasGroupOverlap,
                overlappingGroupNames
            };
        }

        // Добавляет новый отпуск в Firestore после проверки на пересечения
        async function addVacationToFirestore(vacationData) {
            formError.textContent = ''; // Очищаем предыдущие ошибки
            formError.classList.remove('text-red-500', 'text-orange-500'); // Очищаем цвета ошибок

            const { name, start, end, type } = vacationData;

            const overlapResult = checkOverlap(name, type, start, end);

            if (overlapResult.hasStrictOverlap) {
                formError.textContent = `У ${type === 'employee' ? 'сотрудника' : 'бригады'} "${name}" уже есть отпуск, пересекающийся с указанными датами.`;
                formError.classList.add('text-red-500');
                return; // Блокируем добавление, если есть строгое совпадение
            }

            try {
                const docRef = await addDoc(vacationsCollection, vacationData);
                console.log("Документ добавлен с ID: ", docRef.id);

                if (overlapResult.hasGroupOverlap) {
                    formError.textContent = `ВНИМАНИЕ: Отпуск пересекается с отпусками других ${type === 'employee' ? 'сотрудников' : 'бригад'} в этой группе: ${overlapResult.overlappingGroupNames.join(', ')}. Отпуск добавлен.`;
                    formError.classList.add('text-orange-500'); // Выводим предупреждение о пересечении в группе
                }

                await fetchVacations(); // Перезагружаем данные и обновляем отображение
                form.reset(); // Сбрасываем форму
                entityTypeSelect.value = ''; // Сбрасываем селектор типа
                officeEmployeeSelectContainer.style.display = 'none';
                brigadeSelectContainer.style.display = 'none';
            } catch (e) {
                console.error("Ошибка при добавлении отпуска: ", e);
                formError.textContent = "Ошибка при добавлении отпуска. Пожалуйста, попробуйте еще раз.";
                formError.classList.add('text-red-500');
            }
        }

        // Удаляет отпуск из Firestore по ID
        async function deleteVacationFromFirestore(id) {
            try {
                await deleteDoc(doc(db, "vacations", id));
                console.log("Документ успешно удален!");
                await fetchVacations(); // Перезагружаем данные и обновляем отображение
            } catch (e) {
                console.error("Ошибка при удалении отпуска: ", e);
                formError.textContent = "Ошибка при удалении отпуска. Пожалуйста, попробуйте еще раз.";
            }
        }

        // --- Рендеринг и фильтрация ---
        // Рендерит отпуска в таблице
        function renderVacations(filteredVacations) {
            vacationList.innerHTML = ''; // Очищаем таблицу
            if (!filteredVacations || filteredVacations.length === 0) {
                noResultsMessage.style.display = 'block'; // Показываем сообщение, если нет данных
            } else {
                noResultsMessage.style.display = 'none';
            }

            filteredVacations.forEach(vacation => {
                const duration = dateDiffInDays(new Date(vacation.start), new Date(vacation.end));
                const row = `
                    <tr id="vacation-${vacation.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${vacation.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${vacation.type === 'employee' ? 'Сотрудник' : 'Бригада'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(vacation.start)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(vacation.end)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${duration}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openDeleteModal('${vacation.id}')" class="btn btn-danger px-3 py-1 rounded-md text-xs">Удалить</button>
                        </td>
                    </tr>
                `;
                vacationList.insertAdjacentHTML('beforeend', row);
            });
        }

        // Рендерит отпуска в календарном представлении
        function renderCalendarView(filteredVacations) {
            timelineView.innerHTML = '';
            monthHeaderContainer.innerHTML = '';
            daysOfMonthRow.innerHTML = '';
            daysOfMonthRow.style.display = 'none'; // Скрываем шкалу дней по умолчанию

            if (!filteredVacations || filteredVacations.length === 0) {
                noCalendarResultsMessage.style.display = 'block';
                return;
            }
            noCalendarResultsMessage.style.display = 'none';

            let minDate = new Date();
            let maxDate = new Date(minDate.getFullYear(), minDate.getMonth() + 2, 0);

            const yearFilter = filterYearInput.value ? parseInt(filterYearInput.value) : null;
            const monthFilter = filterMonthSelect.value !== "" ? parseInt(filterMonthSelect.value) : null;

            // Определяем диапазон дат для календаря на основе фильтров
            if (yearFilter !== null && monthFilter !== null) {
                // Если выбран конкретный месяц и год
                minDate = new Date(yearFilter, monthFilter, 1);
                maxDate = new Date(yearFilter, monthFilter + 1, 0); // Последний день месяца
                daysOfMonthRow.style.display = 'flex'; // Показываем шкалу дней
            } else if (yearFilter !== null) {
                // Если выбран только год
                minDate = new Date(yearFilter, 0, 1);
                maxDate = new Date(yearFilter, 11, 31);
            } else if (monthFilter !== null) {
                 // Если выбран только месяц (для текущего года)
                 const currentYear = new Date().getFullYear();
                 minDate = new Date(currentYear, monthFilter, 1);
                 maxDate = new Date(currentYear, monthFilter + 1, 0);
                 daysOfMonthRow.style.display = 'flex'; // Показываем шкалу дней
            } else {
                // Если фильтров нет, используем диапазон из данных или дефолтный
                if (filteredVacations.length > 0) {
                     minDate = new Date(Math.min(...filteredVacations.map(v => new Date(v.start).getTime())));
                     maxDate = new Date(Math.max(...filteredVacations.map(v => new Date(v.end).getTime())));
                }
            }


            const totalDaysInRange = dateDiffInDays(minDate, maxDate);
            if (totalDaysInRange <= 0) {
                 noCalendarResultsMessage.style.display = 'block';
                 timelineView.innerHTML = '<p class="text-center text-gray-500">Некорректный диапазон дат для календаря.</p>';
                 return;
            }

            const dayWidthPercentage = 100 / totalDaysInRange;

            // Рендер заголовков месяцев
            let currentMonthIterator = new Date(minDate);
            while (currentMonthIterator <= maxDate) {
                const monthName = currentMonthIterator.toLocaleString('ru-RU', { month: 'long' });
                const year = currentMonthIterator.getFullYear();
                const daysInMonth = new Date(currentMonthIterator.getFullYear(), currentMonthIterator.getMonth() + 1, 0).getDate();

                let daysVisibleInThisMonth = 0;
                for (let i = 0; i < daysInMonth; i++) {
                    const day = new Date(currentMonthIterator.getFullYear(), currentMonthIterator.getMonth(), currentMonthIterator.getDate() + i);
                    if (day >= minDate && day <= maxDate) {
                        daysVisibleInThisMonth++;
                    }
                }

                if (daysVisibleInThisMonth > 0) {
                    const monthHeader = document.createElement('div');
                    monthHeader.classList.add('month-header');
                    monthHeader.textContent = `${monthName} ${year}`;
                    monthHeader.style.width = `${daysVisibleInThisMonth * dayWidthPercentage}%`;
                    monthHeaderContainer.appendChild(monthHeader);
                }
                currentMonthIterator.setMonth(currentMonthIterator.getMonth() + 1);
                currentMonthIterator.setDate(1);
            }

            // Рендер шкалы дней, если выбран конкретный месяц или диапазон небольшой
            if (daysOfMonthRow.style.display === 'flex' && totalDaysInRange <= 31) { // Ограничиваем показ дней до 31, чтобы не перегружать
                let currentDayIterator = new Date(minDate);
                for (let i = 0; i < totalDaysInRange; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('day-of-month-cell');
                    dayCell.textContent = currentDayIterator.getDate();
                    dayCell.style.width = `${dayWidthPercentage}%`;
                    daysOfMonthRow.appendChild(dayCell);
                    currentDayIterator.setDate(currentDayIterator.getDate() + 1);
                }
            }


            // Группируем отпуска по имени/бригаде для отображения на временной шкале
            const vacationsByEntity = filteredVacations.reduce((acc, vacation) => {
                const entityName = vacation.name;
                if (!acc[entityName]) {
                    acc[entityName] = [];
                }
                acc[entityName].push(vacation);
                return acc;
            }, {});

            // Сортируем сущности (сотрудников/бригады) для последовательного отображения
            const sortedEntities = Object.keys(vacationsByEntity).sort((a, b) => {
                const isR_A = a.startsWith('Р') && a.length > 1 && !isNaN(parseInt(a.substring(1)));
                const isR_B = b.startsWith('Р') && b.length > 1 && !isNaN(parseInt(b.substring(1)));

                if (isR_A && isR_B) { // Если обе бригады, сортируем по номеру
                    return parseInt(a.substring(1)) - parseInt(b.substring(1));
                }
                if (isR_A) return 1; // Бригады идут после обычных имен
                if (isR_B) return -1;
                return a.localeCompare(b); // Обычная алфавитная сортировка для имен
            });


            sortedEntities.forEach(entityName => {
                const employeeTimeline = document.createElement('div');
                employeeTimeline.classList.add('employee-timeline');

                const nameDiv = document.createElement('div');
                nameDiv.classList.add('employee-name-calendar');
                nameDiv.textContent = entityName;
                employeeTimeline.appendChild(nameDiv);

                const daysContainer = document.createElement('div');
                daysContainer.classList.add('days-container');

                vacationsByEntity[entityName].forEach(vacation => {
                    const vacStart = new Date(vacation.start);
                    const vacEnd = new Date(vacation.end);

                    // Определяем видимый диапазон отпуска в рамках текущего отображения календаря
                    const displayStart = new Date(Math.max(vacStart.getTime(), minDate.getTime()));
                    const displayEnd = new Date(Math.min(vacEnd.getTime(), maxDate.getTime()));

                    if (displayStart <= displayEnd) { // Если отпуск хотя бы частично в диапазоне
                        const offsetDays = dateDiffInDays(minDate, displayStart) -1; // Смещение от начала диапазона
                        const durationInView = dateDiffInDays(displayStart, displayEnd); // Длительность в видимом диапазоне

                        const dayBlock = document.createElement('div');
                        dayBlock.classList.add('day-block');
                        if (vacation.type === 'brigade') {
                            dayBlock.classList.add('brigade'); // Изумрудный цвет для бригад
                        }
                        dayBlock.style.left = `${offsetDays * dayWidthPercentage}%`;
                        dayBlock.style.width = `${durationInView * dayWidthPercentage}%`;
                        if (durationInView * dayWidthPercentage > 5) { // Показываем текст, если достаточно места
                           dayBlock.textContent = `Отпуск`;
                        }
                        daysContainer.appendChild(dayBlock);
                    }
                });
                employeeTimeline.appendChild(daysContainer);
                timelineView.appendChild(employeeTimeline);
            });
        }


        // --- Обработчики форм и модальных окон ---
        // Обработчик формы добавления отпуска
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            formError.textContent = ''; // Очищаем ошибки
            formError.classList.remove('text-red-500', 'text-orange-500'); // Очищаем цвета ошибок

            const entityType = entityTypeSelect.value;
            let name = '';

            // Определяем имя/бригаду в зависимости от выбранного типа
            if (entityType === 'employee') {
                name = officeEmployeeNameSelect.value;
            } else if (entityType === 'brigade') {
                name = brigadeNameSelect.value;
            } else {
                formError.textContent = 'Пожалуйста, выберите тип (Сотрудник офиса или Бригада цеха).';
                formError.classList.add('text-red-500');
                return;
            }

            if (!name) {
                 formError.textContent = `Пожалуйста, выберите ${entityType === 'employee' ? 'сотрудника' : 'бригаду'}.`;
                 formError.classList.add('text-red-500');
                 return;
            }

            const start = form.vacationStart.value;
            const end = form.vacationEnd.value;

            if (!start || !end) {
                formError.textContent = 'Начало и конец отпуска обязательны для заполнения.';
                formError.classList.add('text-red-500');
                return;
            }

            const startDate = new Date(start);
            const endDate = new Date(end);

            if (endDate < startDate) {
                formError.textContent = 'Дата окончания отпуска не может быть раньше даты начала.';
                formError.classList.add('text-red-500');
                return;
            }
            
            // Вызов функции addVacationToFirestore, которая содержит логику проверки пересечений
            await addVacationToFirestore({ name, start, end, type: entityType });
        });

        // Модальное окно подтверждения удаления отпуска
        closeModalButton.onclick = () => confirmDeleteModal.style.display = 'none';
        cancelDeleteButton.onclick = () => confirmDeleteModal.style.display = 'none';
        confirmDeleteButtonAction.onclick = async function() {
            if (vacationToDeleteId !== null) {
                await deleteVacationFromFirestore(vacationToDeleteId);
                confirmDeleteModal.style.display = 'none';
            }
        };

        // Модальное окно подтверждения удаления сотрудника
        closeEmployeeModalButton.onclick = () => confirmDeleteEmployeeModal.style.display = 'none';
        cancelDeleteEmployeeButton.onclick = () => confirmDeleteEmployeeModal.style.display = 'none';
        confirmDeleteEmployeeButtonAction.onclick = async function() {
            console.log('Confirm Delete Employee button clicked!'); // Отладочное сообщение
            if (employeeToDeleteId !== null) {
                await deleteEmployeeAndTheirVacations(employeeToDeleteId, employeeToDeleteName);
                confirmDeleteEmployeeModal.style.display = 'none';
            }
        };

        // Закрытие модальных окон при клике вне их
        window.onclick = function(event) {
            if (event.target == confirmDeleteModal) {
                confirmDeleteModal.style.display = 'none';
            }
            if (event.target == confirmDeleteEmployeeModal) {
                confirmDeleteEmployeeModal.style.display = 'none';
            }
        };


        // --- Фильтры и экспорт XLS ---
        // Заполняет выпадающий список месяцев для фильтра
        function populateFilterOptions() {
            const currentMonthValue = filterMonthSelect.value;
            filterMonthSelect.innerHTML = '<option value="">Все месяцы</option>';

            const months = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                filterMonthSelect.appendChild(option);
            });
            filterMonthSelect.value = currentMonthValue;
        }

        // Применяет фильтры и обновляет отображение
        function applyAllFilters() {
            const monthFilter = filterMonthSelect.value;
            const yearFilter = filterYearInput.value;

            let filtered = vacations; // Начинаем со всех загруженных отпусков

            if (yearFilter) {
                filtered = filtered.filter(v => {
                    const startYear = new Date(v.start).getFullYear();
                    const endYear = new Date(v.end).getFullYear();
                    // Отпуск считается в году, если он начинается ИЛИ заканчивается в этом году
                    return startYear === parseInt(yearFilter) || endYear === parseInt(yearFilter);
                });
            }

            if (monthFilter !== "") { // Если выбран конкретный месяц (0-11)
                filtered = filtered.filter(v => {
                    const vacStart = new Date(v.start);
                    const vacEnd = new Date(v.end);
                    // Определяем начало и конец месяца для фильтрации
                    const filterMonthDateStart = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter), 1);
                    const filterMonthDateEnd = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter) + 1, 0);

                    // Отпуск попадает в месяц, если его интервал пересекается с интервалом месяца
                    return (vacStart <= filterMonthDateEnd && vacEnd >= filterMonthDateStart);
                });
            }
            renderVacations(filtered); // Рендерим таблицу
            renderCalendarView(filtered); // Рендерим календарь
        }

        applyFiltersButton.addEventListener('click', applyAllFilters);

        // Обработчик кнопки экспорта в XLS
        exportXlsButton.addEventListener('click', () => {
            // Получаем данные, которые сейчас отображаются в таблице (отфильтрованные)
            const dataToExport = vacations.filter(v => {
                const monthFilter = filterMonthSelect.value;
                const yearFilter = filterYearInput.value;

                let matchesFilters = true;

                if (yearFilter) {
                    const startYear = new Date(v.start).getFullYear();
                    const endYear = new Date(v.end).getFullYear();
                    matchesFilters = matchesFilters && (startYear === parseInt(yearFilter) || endYear === parseInt(yearFilter));
                }

                if (monthFilter !== "") {
                    const vacStart = new Date(v.start);
                    const vacEnd = new Date(v.end);
                    const filterMonthDateStart = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter), 1);
                    const filterMonthDateEnd = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter) + 1, 0);
                    matchesFilters = matchesFilters && (vacStart <= filterMonthDateEnd && vacEnd >= filterMonthDateStart);
                }
                return matchesFilters;
            }).map(v => ({
                'Имя/Бригада': v.name,
                'Тип': v.type === 'employee' ? 'Сотрудник' : 'Бригада',
                'Начало отпуска': formatDate(v.start),
                'Конец отпуска': formatDate(v.end),
                'Длительность (дни)': dateDiffInDays(new Date(v.start), new Date(v.end))
            }));

            if (dataToExport.length === 0) {
                alert('Нет данных для экспорта с учетом текущих фильтров.');
                return;
            }

            // Создаем рабочий лист из JSON данных
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            // Создаем рабочую книгу и добавляем лист
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "График отпусков");
            // Записываем файл
            XLSX.writeFile(wb, "график_отпусков.xls");
        });


        // Инициализация приложения при полной загрузке DOM
        document.addEventListener('DOMContentLoaded', async () => {
            populateFilterOptions();
            const currentYear = new Date().getFullYear();
            filterYearInput.value = currentYear;
            await fetchOfficeEmployees(); // Загружаем сотрудников офиса
            await fetchVacations(); // Загружаем отпуска
        });

    </script>
</body>
</html>
