<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>График отпусков сотрудников</title>
    <script src="https://cdn.tailwindcss.com "></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter :wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn {
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
        .calendar-view {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-700">График отпусков сотрудников</h1>

        <!-- Форма добавления -->
        <form id="addVacationForm" class="mb-8 p-6 bg-gray-50 rounded-lg shadow">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="employeeName" class="block text-sm font-medium text-gray-700 mb-1">Имя сотрудника:</label>
                    <input type="text" id="employeeName" name="employeeName" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="vacationStart" class="block text-sm font-medium text-gray-700 mb-1">Начало отпуска:</label>
                    <input type="date" id="vacationStart" name="vacationStart" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="vacationEnd" class="block text-sm font-medium text-gray-700 mb-1">Конец отпуска:</label>
                    <input type="date" id="vacationEnd" name="vacationEnd" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-end">
                    <button type="submit" class="btn btn-primary w-full py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Добавить отпуск
                    </button>
                </div>
            </div>
            <p id="formError" class="text-red-500 text-sm mt-2"></p>
        </form>

        <!-- Кнопки импорта/экспорта -->
        <div class="mt-6 flex gap-4">
            <button id="exportButton" class="btn btn-primary px-4 py-2 rounded-md">Сохранить в файл</button>
            <label class="btn btn-primary px-4 py-2 rounded-md cursor-pointer">
                Загрузить из файла
                <input type="file" id="importFile" accept=".json" hidden>
            </label>
        </div>

        <!-- Таблица отпусков -->
        <div class="overflow-x-auto bg-white shadow rounded-lg mt-6">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Сотрудник</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Начало</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Конец</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дней</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                    </tr>
                </thead>
                <tbody id="vacationList"></tbody>
            </table>
        </div>

        <!-- Модальное окно удаления -->
        <div id="confirmDeleteModal" class="modal">
            <div class="modal-content">
                <span id="closeModalButton" class="float-right text-2xl font-bold">&times;</span>
                <h2 class="text-lg font-semibold mb-4">Подтвердите удаление</h2>
                <p>Вы уверены, что хотите удалить этот отпуск?</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancelDeleteButton" class="btn px-4 py-2 bg-gray-300 text-gray-800 rounded-md">Отмена</button>
                    <button id="confirmDeleteButtonAction" class="btn btn-danger px-4 py-2 rounded-md">Удалить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let vacations = [];
        let vacationToDeleteIndex = null;

        const form = document.getElementById('addVacationForm');
        const vacationList = document.getElementById('vacationList');
        const formError = document.getElementById('formError');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButtonAction = document.getElementById('confirmDeleteButtonAction');
        const exportButton = document.getElementById('exportButton');
        const importFile = document.getElementById('importFile');

        // === Экспорт в файл ===
        exportButton.addEventListener('click', () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(vacations, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "graphik_otpuskov.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        // === Импорт из файла ===
        importFile.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedVacations = JSON.parse(e.target.result);
                        if (Array.isArray(importedVacations) && importedVacations.every(v =>
                            v.name && v.start && v.end
                        )) {
                            vacations = importedVacations;
                            renderVacations();
                            alert('Данные успешно загружены!');
                        } else {
                            throw new Error('Некорректный формат файла.');
                        }
                    } catch (error) {
                        alert('Ошибка при чтении файла: ' + error.message);
                    }
                };
                reader.readAsText(file);
            } else {
                alert('Пожалуйста, выберите корректный JSON-файл.');
            }
        });

        // === Рендер таблицы ===
        function renderVacations() {
            vacationList.innerHTML = '';
            if (vacations.length === 0) {
                vacationList.innerHTML = '<tr><td colspan="5" class="text-center p-4">Нет данных</td></tr>';
                return;
            }
            vacations.forEach((vacation, index) => {
                const duration = dateDiffInDays(vacation.start, vacation.end);
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${vacation.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(vacation.start)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(vacation.end)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${duration}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="openDeleteModal(${index})" class="btn btn-danger px-3 py-1 rounded-md text-xs">Удалить</button>
                        </td>
                    </tr>`;
                vacationList.insertAdjacentHTML('beforeend', row);
            });
        }

        // === Обработчик формы ===
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            formError.textContent = '';
            const name = form.employeeName.value.trim();
            const start = form.vacationStart.value;
            const end = form.vacationEnd.value;

            if (!name || !start || !end) {
                formError.textContent = 'Все поля обязательны для заполнения.';
                return;
            }

            const startDate = new Date(start);
            const endDate = new Date(end);

            if (endDate < startDate) {
                formError.textContent = 'Дата окончания не может быть раньше начала.';
                return;
            }

            const overlapping = vacations.find(v =>
                v.name === name &&
                !(endDate < new Date(v.start) || startDate > new Date(v.end))
            );

            if (overlapping) {
                formError.textContent = `У этого сотрудника уже есть отпуск в эти дни.`;
                return;
            }

            vacations.push({ name, start, end });
            renderVacations();
            form.reset();
        });

        // === Удаление ===
        function openDeleteModal(index) {
            vacationToDeleteIndex = index;
            confirmDeleteModal.style.display = 'block';
        }

        function closeDeleteModal() {
            confirmDeleteModal.style.display = 'none';
            vacationToDeleteIndex = null;
        }

        closeModalButton.onclick = closeDeleteModal;
        cancelDeleteButton.onclick = closeDeleteModal;

        confirmDeleteButtonAction.onclick = function() {
            if (vacationToDeleteIndex !== null) {
                vacations.splice(vacationToDeleteIndex, 1);
                renderVacations();
                closeDeleteModal();
            }
        };

        // === Вспомогательные функции ===
        function dateDiffInDays(date1Str, date2Str) {
            const date1 = new Date(date1Str);
            const date2 = new Date(date2Str);
            if (isNaN(date1) || isNaN(date2)) return 0;
            const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24)) + 1;
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
        }

        // === Инициализация ===
        document.addEventListener('DOMContentLoaded', () => {
            renderVacations();
        });
    </script>
</body>
</html>
