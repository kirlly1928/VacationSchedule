<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График отпусков сотрудников</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-HwWSFCgbt0wq69ZfHQfgcd9P3rkE6ofkStlYmpfyHWFXCjpmoH4/yQfZh7fibkdKJKYghRKebIpUoUIHRV0XPMCA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Светло-серый фон */
        }
        .container {
            max-width: 1000px; /* Увеличена максимальная ширина для лучшего отображения таблицы */
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem; /* Закругленные углы */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .table-header th {
            background-color: #e5e7eb; /* Фон заголовков таблицы */
        }
        .btn {
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #3b82f6; /* Синий */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: #ef4444; /* Красный */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #22c55e; /* Зеленый */
            color: white;
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .modal {
            display: none; /* Скрыто по умолчанию */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Стили для визуализации календаря */
        .calendar-view {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            overflow-x: auto; /* Горизонтальная прокрутка для календаря */
        }
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Пространство между сотрудниками */
        }
        .employee-timeline {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .employee-name-calendar {
            width: 150px; /* Фиксированная ширина для имени сотрудника */
            min-width: 100px; /* Минимальная ширина для адаптивности */
            font-weight: 500;
            padding-right: 1rem;
            flex-shrink: 0; /* Предотвращает сжатие имени */
        }
        .days-container {
            display: flex;
            flex-grow: 1; /* Занимает оставшееся пространство */
            position: relative; /* Для позиционирования отпускных блоков */
            height: 30px; /* Высота полосы для дней */
            background-color: #e5e7eb; /* Фон для полосы дней */
            border-radius: 0.25rem;
        }
        .day-block {
            position: absolute; /* Позиционирование относительно days-container */
            height: 100%;
            background-color: #60a5fa; /* Синий цвет для отпуска по умолчанию */
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            opacity: 0.8;
            overflow: hidden; /* Обрезать текст, если не помещается */
            white-space: nowrap; /* Запретить перенос текста */
        }
        .day-block.brigade {
            background-color: #34d399; /* Изумрудный цвет для бригад (emerald-400) */
        }
        .month-header-container {
            display: flex;
            margin-bottom: 0.5rem;
            padding-left: 166px; /* 150px (имя) + 1rem (отступ) */
        }
        .month-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            border-right: 1px solid #d1d5db; /* Разделитель между месяцами */
            height: 30px;
        }
        .month-header:last-child {
            border-right: none;
        }
        .days-of-month-row {
            display: flex;
            margin-bottom: 0.5rem;
            padding-left: 166px; /* Совпадает с отступом для имен */
        }
        .day-of-month-cell {
            text-align: center;
            font-size: 0.7rem;
            color: #6b7280;
            flex-shrink: 0;
            box-sizing: border-box;
            border-right: 1px dashed #d1d5db; /* Пунктирная линия для дней */
        }
        .day-of-month-cell:last-child {
            border-right: none;
        }
        /* Стили для списка сотрудников */
        #officeEmployeesList ul {
            list-style: none;
            padding: 0;
        }
        #officeEmployeesList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        #officeEmployeesList li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container" id="content-to-export">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-700">График отпусков сотрудников и бригад</h1>

        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Управление сотрудниками офиса</h2>
            <form id="addOfficeEmployeeForm" class="flex flex-col sm:flex-row gap-4 items-end mb-4">
                <div class="flex-grow w-full sm:w-auto">
                    <label for="newOfficeEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Имя нового сотрудника:</label>
                    <input type="text" id="newOfficeEmployeeName" name="newOfficeEmployeeName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="btn btn-primary py-2 px-4 rounded-md shadow-sm w-full sm:w-auto">Добавить</button>
            </form>
            <p id="employeeFormError" class="text-red-500 text-sm mt-2"></p>

            <div id="officeEmployeesList" class="mt-4">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Список сотрудников офиса:</h3>
                <ul>
                    </ul>
                <p id="noOfficeEmployeesMessage" class="text-center text-gray-500 mt-4" style="display: none;">Список сотрудников пуст.</p>
            </div>
        </div>

        <form id="addVacationForm" class="mb-8 p-6 bg-gray-50 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Добавить отпуск</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="entityType" class="block text-sm font-medium text-gray-700 mb-1">Тип:</label>
                    <select id="entityType" name="entityType" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Выберите тип</option>
                        <option value="employee">Сотрудник офиса</option>
                        <option value="brigade">Бригада цеха</option>
                    </select>
                </div>
                <div id="officeEmployeeSelectContainer" class="w-full" style="display: none;">
                    <label for="officeEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Сотрудник офиса:</label>
                    <select id="officeEmployeeName" name="officeEmployeeName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Выберите сотрудника</option>
                    </select>
                </div>
                <div id="brigadeSelectContainer" class="w-full" style="display: none;">
                    <label for="brigadeName" class="block text-sm font-medium text-gray-700 mb-1">Бригада цеха:</label>
                    <select id="brigadeName" name="brigadeName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Выберите бригаду</option>
                        <option value="Р1">Р1</option>
                        <option value="Р2">Р2</option>
                        <option value="Р3">Р3</option>
                        <option value="Р4">Р4</option>
                        <option value="Р5">Р5</option>
                        <option value="Р6">Р6</option>
                        <option value="Р7">Р7</option>
                        <option value="Р8">Р8</option>
                    </select>
                </div>
                <div>
                    <label for="vacationStart" class="block text-sm font-medium text-gray-700 mb-1">Начало отпуска:</label>
                    <input type="date" id="vacationStart" name="vacationStart" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="vacationEnd" class="block text-sm font-medium text-gray-700 mb-1">Конец отпуска:</label>
                    <input type="date" id="vacationEnd" name="vacationEnd" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-end w-full">
                    <button type="submit" class="btn btn-primary w-full py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Добавить отпуск
                    </button>
                </div>
            </div>
            <p id="formError" class="text-red-500 text-sm mt-2"></p>
        </form>

        <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
            <div class="w-full sm:w-auto">
                <label for="filterMonth" class="block text-sm font-medium text-gray-700 mb-1">Фильтр по месяцу:</label>
                <select id="filterMonth" class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Все месяцы</option>
                    </select>
            </div>
            <div class="w-full sm:w-auto">
                <label for="filterYear" class="block text-sm font-medium text-gray-700 mb-1">Фильтр по году:</label>
                <input type="number" id="filterYear" placeholder="Год (напр. 2024)"
                       class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
             <button id="applyFilters" class="btn btn-primary mt-3 sm:mt-0 sm:self-end py-2 px-4 rounded-md shadow-sm w-full sm:w-auto">Применить фильтры</button>
             <button id="exportPdfButton" class="btn btn-success mt-3 sm:mt-0 sm:self-end py-2 px-4 rounded-md shadow-sm w-full sm:w-auto">Экспорт в PDF</button>
        </div>


        <div class="overflow-x-auto bg-white shadow rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="table-header">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя/Бригада</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тип</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Начало отпуска</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Конец отпуска</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Длительность (дни)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                    </tr>
                </thead>
                <tbody id="vacationList" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
         <p id="noResultsMessage" class="text-center text-gray-500 mt-4" style="display: none;">Нет данных для отображения с учетом выбранных фильтров.</p>

        <div class="calendar-view">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Календарь отпусков</h2>
            <div id="monthHeaderContainer" class="month-header-container">
                </div>
            <div id="daysOfMonthRow" class="days-of-month-row" style="display: none;">
                </div>
            <div id="timelineView" class="timeline">
                </div>
             <p id="noCalendarResultsMessage" class="text-center text-gray-500 mt-4" style="display: none;">Нет данных для отображения в календаре с учетом выбранных фильтров.</p>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalButton">&times;</span>
            <h2 class="text-lg font-semibold mb-4">Подтверждение удаления отпуска</h2>
            <p>Вы уверены, что хотите удалить этот отпуск?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelDeleteButton" class="btn px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Отмена</button>
                <button id="confirmDeleteButtonAction" class="btn btn-danger px-4 py-2 rounded-md">Удалить</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteEmployeeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEmployeeModalButton">&times;</span>
            <h2 class="text-lg font-semibold mb-4">Подтверждение удаления сотрудника</h2>
            <p>Вы уверены, что хотите удалить сотрудника "<span id="employeeToDeleteName"></span>" и ВСЕ его отпуска?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelDeleteEmployeeButton" class="btn px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Отмена</button>
                <button id="confirmDeleteEmployeeButtonAction" class="btn btn-danger px-4 py-2 rounded-md">Удалить</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // КОНФИГУРАЦИЯ FIREBASE: Ваши данные
        const firebaseConfig = {
            apiKey: "AIzaSyCS8kdoT-6msPuErRXYPYeP2PxTqzNKV6A",
            authDomain: "vacation-d2585.firebaseapp.com",
            projectId: "vacation-d2585",
            storageBucket: "vacation-d2585.firebasestorage.app",
            messagingSenderId: "1026454413781",
            appId: "1:1026454413781:web:dad360421616ee782c9d5c",
            measurementId: "G-9ZCD95E2F7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const vacationsCollection = collection(db, "vacations");
        const officeEmployeesCollection = collection(db, "officeEmployees");

        let vacations = [];
        let officeEmployees = [];
        let vacationToDeleteId = null;
        let employeeToDeleteId = null;
        let employeeToDeleteName = '';

        // Элементы DOM - общие
        const form = document.getElementById('addVacationForm');
        const formError = document.getElementById('formError');
        const vacationList = document.getElementById('vacationList');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const noCalendarResultsMessage = document.getElementById('noCalendarResultsMessage');
        const timelineView = document.getElementById('timelineView');
        const monthHeaderContainer = document.getElementById('monthHeaderContainer');
        const daysOfMonthRow = document.getElementById('daysOfMonthRow');
        const exportPdfButton = document.getElementById('exportPdfButton');

        // Элементы DOM - модальное окно отпуска
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButtonAction = document.getElementById('confirmDeleteButtonAction');

        // Элементы DOM - модальное окно сотрудника
        const confirmDeleteEmployeeModal = document.getElementById('confirmDeleteEmployeeModal');
        const closeEmployeeModalButton = document.getElementById('closeEmployeeModalButton');
        const cancelDeleteEmployeeButton = document.getElementById('cancelDeleteEmployeeButton');
        const confirmDeleteEmployeeButtonAction = document.getElementById('confirmDeleteEmployeeButtonAction');
        const employeeToDeleteNameSpan = document.getElementById('employeeToDeleteName');


        // Элементы DOM - сотрудники офиса
        const addOfficeEmployeeForm = document.getElementById('addOfficeEmployeeForm');
        const newOfficeEmployeeNameInput = document.getElementById('newOfficeEmployeeName');
        const employeeFormError = document.getElementById('employeeFormError');
        const officeEmployeesList = document.getElementById('officeEmployeesList').querySelector('ul');
        const noOfficeEmployeesMessage = document.getElementById('noOfficeEmployeesMessage');

        // Элементы DOM - добавление отпуска
        const entityTypeSelect = document.getElementById('entityType');
        const officeEmployeeSelectContainer = document.getElementById('officeEmployeeSelectContainer');
        const officeEmployeeNameSelect = document.getElementById('officeEmployeeName');
        const brigadeSelectContainer = document.getElementById('brigadeSelectContainer');
        const brigadeNameSelect = document.getElementById('brigadeName');

        // Элементы DOM - фильтры
        const filterMonthSelect = document.getElementById('filterMonth');
        const filterYearInput = document.getElementById('filterYear');
        const applyFiltersButton = document.getElementById('applyFilters');

        const MS_PER_DAY = 1000 * 60 * 60 * 24;

        function dateDiffInDays(date1, date2) {
            const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.floor((utc2 - utc1) / MS_PER_DAY) + 1;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                return dateStr;
            }
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // --- ГЛОБАЛЬНЫЕ ФУНКЦИИ для ONCLICK в HTML ---
        window.openDeleteModal = function(id) {
            vacationToDeleteId = id;
            confirmDeleteModal.style.display = 'block';
        };

        window.openDeleteEmployeeModal = function(id, name) {
            employeeToDeleteId = id;
            employeeToDeleteName = name;
            employeeToDeleteNameSpan.textContent = name;
            confirmDeleteEmployeeModal.style.display = 'block';
        };


        // --- Функции для сотрудников офиса ---
        async function fetchOfficeEmployees() {
            try {
                const querySnapshot = await getDocs(query(officeEmployeesCollection, orderBy('name')));
                officeEmployees = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateOfficeEmployeeSelect();
                renderOfficeEmployeesList();
            } catch (e) {
                console.error("Ошибка при загрузке сотрудников офиса: ", e);
            }
        }

        function populateOfficeEmployeeSelect() {
            officeEmployeeNameSelect.innerHTML = '<option value="">Выберите сотрудника</option>';
            officeEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = emp.name;
                officeEmployeeNameSelect.appendChild(option);
            });
        }

        function renderOfficeEmployeesList() {
            officeEmployeesList.innerHTML = '';
            if (officeEmployees.length === 0) {
                noOfficeEmployeesMessage.style.display = 'block';
            } else {
                noOfficeEmployeesMessage.style.display = 'none';
                officeEmployees.forEach(emp => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>${emp.name}</span>
                        <button onclick="openDeleteEmployeeModal('${emp.id}', '${emp.name}')" class="btn btn-danger px-2 py-1 rounded-md text-xs">Удалить</button>
                    `;
                    officeEmployeesList.appendChild(listItem);
                });
            }
        }

        addOfficeEmployeeForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            employeeFormError.textContent = '';
            const newEmployeeName = newOfficeEmployeeNameInput.value.trim();

            if (!newEmployeeName) {
                employeeFormError.textContent = 'Имя сотрудника не может быть пустым.';
                return;
            }

            if (officeEmployees.some(emp => emp.name === newEmployeeName)) {
                employeeFormError.textContent = `Сотрудник "${newEmployeeName}" уже существует.`;
                return;
            }

            try {
                await addDoc(officeEmployeesCollection, { name: newEmployeeName });
                newOfficeEmployeeNameInput.value = '';
                await fetchOfficeEmployees();
            } catch (e) {
                console.error("Ошибка при добавлении сотрудника: ", e);
                employeeFormError.textContent = "Ошибка при добавлении сотрудника. Пожалуйста, попробуйте еще раз.";
            }
        });

        // --- Удаление сотрудника и его отпусков ---
        async function deleteEmployeeAndTheirVacations(employeeId, employeeName) {
            const batch = db.batch(); // Используем batch() вместо writeBatch(db)

            const employeeDocRef = doc(db, "officeEmployees", employeeId);
            batch.delete(employeeDocRef);

            const q = query(vacationsCollection, where("name", "==", employeeName), where("type", "==", "employee"));
            const vacationsSnapshot = await getDocs(q);

            vacationsSnapshot.forEach((vacDoc) => {
                batch.delete(vacDoc.ref);
            });

            try {
                await batch.commit();
                console.log(`Сотрудник ${employeeName} и все его отпуска успешно удалены.`);
                await fetchOfficeEmployees();
                await fetchVacations();
            } catch (e) {
                console.error("Ошибка при удалении сотрудника и его отпусков: ", e);
                alert("Ошибка при удалении сотрудника и его отпусков. Пожалуйста, попробуйте еще раз.");
            }
        }


        // --- Логика переключения полей выбора ---
        entityTypeSelect.addEventListener('change', function() {
            if (this.value === 'employee') {
                officeEmployeeSelectContainer.style.display = 'block';
                brigadeSelectContainer.style.display = 'none';
                officeEmployeeNameSelect.setAttribute('required', 'required');
                brigadeNameSelect.removeAttribute('required');
            } else if (this.value === 'brigade') {
                officeEmployeeSelectContainer.style.display = 'none';
                brigadeSelectContainer.style.display = 'block';
                brigadeNameSelect.setAttribute('required', 'required');
                officeEmployeeNameSelect.removeAttribute('required');
            } else {
                officeEmployeeSelectContainer.style.display = 'none';
                brigadeSelectContainer.style.display = 'none';
                officeEmployeeNameSelect.removeAttribute('required');
                brigadeNameSelect.removeAttribute('required');
            }
        });


        // --- Функции для взаимодействия с Firestore (Отпуска) ---
        async function fetchVacations() {
            try {
                const q = query(vacationsCollection, orderBy("start"));
                const querySnapshot = await getDocs(q);
                vacations = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyAllFilters();
            }
            catch (e) {
                console.error("Ошибка при загрузке отпусков из Firestore: ", e);
                formError.textContent = "Ошибка при загрузке данных. Пожалуйста, попробуйте еще раз.";
            }
        }

        // Функция для проверки пересечения дат отпусков
        function checkOverlap(newName, newType, newStart, newEnd) {
            const newStartDate = new Date(newStart);
            const newEndDate = new Date(newEnd);
            let hasStrictOverlap = false; // Пересечение с тем же сотрудником/бригадой (ошибка)
            let hasGroupOverlap = false;  // Пересечение с другим сотрудником/бригадой в той же группе (предупреждение)
            let overlappingGroupNames = [];

            vacations.forEach(v => {
                const existingStartDate = new Date(v.start);
                const existingEndDate = new Date(v.end);

                // Проверяем, пересекаются ли интервалы
                const isOverlap = (newStartDate <= existingEndDate && newEndDate >= existingStartDate);

                if (isOverlap) {
                    if (v.name === newName && v.type === newType) {
                        hasStrictOverlap = true; // Отпуск для того же сотрудника/бригады
                    } else if (v.type === newType) {
                        hasGroupOverlap = true; // Отпуск для другого сотрудника/бригады в той же группе
                        if (!overlappingGroupNames.includes(v.name)) {
                            overlappingGroupNames.push(v.name);
                        }
                    }
                }
            });

            return {
                hasStrictOverlap,
                hasGroupOverlap,
                overlappingGroupNames
            };
        }


        async function addVacationToFirestore(vacationData) {
            formError.textContent = ''; // Очищаем предыдущие ошибки
            formError.classList.remove('text-red-500', 'text-orange-500'); // Очищаем цвета

            const { name, start, end, type } = vacationData;

            const overlapResult = checkOverlap(name, type, start, end);

            if (overlapResult.hasStrictOverlap) {
                formError.textContent = `У ${type === 'employee' ? 'сотрудника' : 'бригады'} "${name}" уже есть отпуск, пересекающийся с указанными датами.`;
                formError.classList.add('text-red-500');
                return; // Блокируем добавление
            }

            try {
                const docRef = await addDoc(vacationsCollection, vacationData);
                console.log("Документ добавлен с ID: ", docRef.id);

                if (overlapResult.hasGroupOverlap) {
                    formError.textContent = `ВНИМАНИЕ: Отпуск пересекается с отпусками других ${type === 'employee' ? 'сотрудников' : 'бригад'} в этой группе: ${overlapResult.overlappingGroupNames.join(', ')}. Отпуск добавлен.`;
                    formError.classList.add('text-orange-500'); // Выводим предупреждение
                }

                await fetchVacations();
                form.reset();
                entityTypeSelect.value = '';
                officeEmployeeSelectContainer.style.display = 'none';
                brigadeSelectContainer.style.display = 'none';
            } catch (e) {
                console.error("Ошибка при добавлении отпуска: ", e);
                formError.textContent = "Ошибка при добавлении отпуска. Пожалуйста, попробуйте еще раз.";
                formError.classList.add('text-red-500');
            }
        }

        async function deleteVacationFromFirestore(id) {
            try {
                await deleteDoc(doc(db, "vacations", id));
                console.log("Документ успешно удален!");
                await fetchVacations();
            } catch (e) {
                console.error("Ошибка при удалении отпуска: ", e);
                formError.textContent = "Ошибка при удалении отпуска. Пожалуйста, попробуйте еще раз.";
            }
        }

        // --- Рендеринг и фильтрация ---
        function renderVacations(filteredVacations) {
            vacationList.innerHTML = '';
            if (!filteredVacations || filteredVacations.length === 0) {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
            }

            filteredVacations.forEach(vacation => {
                const duration = dateDiffInDays(new Date(vacation.start), new Date(vacation.end));
                const row = `
                    <tr id="vacation-${vacation.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${vacation.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${vacation.type === 'employee' ? 'Сотрудник' : 'Бригада'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(vacation.start)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(vacation.end)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${duration}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openDeleteModal('${vacation.id}')" class="btn btn-danger px-3 py-1 rounded-md text-xs">Удалить</button>
                        </td>
                    </tr>
                `;
                vacationList.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderCalendarView(filteredVacations) {
            timelineView.innerHTML = '';
            monthHeaderContainer.innerHTML = '';
            daysOfMonthRow.innerHTML = '';
            daysOfMonthRow.style.display = 'none';

            if (!filteredVacations || filteredVacations.length === 0) {
                noCalendarResultsMessage.style.display = 'block';
                return;
            }
            noCalendarResultsMessage.style.display = 'none';

            let minDate = new Date();
            let maxDate = new Date(minDate.getFullYear(), minDate.getMonth() + 2, 0);

            const yearFilter = filterYearInput.value ? parseInt(filterYearInput.value) : null;
            const monthFilter = filterMonthSelect.value !== "" ? parseInt(filterMonthSelect.value) : null;

            if (yearFilter !== null && monthFilter !== null) {
                minDate = new Date(yearFilter, monthFilter, 1);
                maxDate = new Date(yearFilter, monthFilter + 1, 0);
                daysOfMonthRow.style.display = 'flex';
            } else if (yearFilter !== null) {
                minDate = new Date(yearFilter, 0, 1);
                maxDate = new Date(yearFilter, 11, 31);
            } else if (monthFilter !== null) {
                 const currentYear = new Date().getFullYear();
                 minDate = new Date(currentYear, monthFilter, 1);
                 maxDate = new Date(currentYear, monthFilter + 1, 0);
                 daysOfMonthRow.style.display = 'flex';
            } else {
                if (filteredVacations.length > 0) {
                     minDate = new Date(Math.min(...filteredVacations.map(v => new Date(v.start).getTime())));
                     maxDate = new Date(Math.max(...filteredVacations.map(v => new Date(v.end).getTime())));
                }
            }


            const totalDaysInRange = dateDiffInDays(minDate, maxDate);
            if (totalDaysInRange <= 0) {
                 noCalendarResultsMessage.style.display = 'block';
                 timelineView.innerHTML = '<p class="text-center text-gray-500">Некорректный диапазон дат для календаря.</p>';
                 return;
            }

            const dayWidthPercentage = 100 / totalDaysInRange;

            let currentMonthIterator = new Date(minDate);
            while (currentMonthIterator <= maxDate) {
                const monthName = currentMonthIterator.toLocaleString('ru-RU', { month: 'long' });
                const year = currentMonthIterator.getFullYear();
                const daysInMonth = new Date(currentMonthIterator.getFullYear(), currentMonthIterator.getMonth() + 1, 0).getDate();

                let daysVisibleInThisMonth = 0;
                for (let i = 0; i < daysInMonth; i++) {
                    const day = new Date(currentMonthIterator.getFullYear(), currentMonthIterator.getMonth(), currentMonthIterator.getDate() + i);
                    if (day >= minDate && day <= maxDate) {
                        daysVisibleInThisMonth++;
                    }
                }

                if (daysVisibleInThisMonth > 0) {
                    const monthHeader = document.createElement('div');
                    monthHeader.classList.add('month-header');
                    monthHeader.textContent = `${monthName} ${year}`;
                    monthHeader.style.width = `${daysVisibleInThisMonth * dayWidthPercentage}%`;
                    monthHeaderContainer.appendChild(monthHeader);
                }
                currentMonthIterator.setMonth(currentMonthIterator.getMonth() + 1);
                currentMonthIterator.setDate(1);
            }

            if (daysOfMonthRow.style.display === 'flex') {
                // Determine the actual start and end day for the days-of-month row
                // This will be the start day of minDate and end day of maxDate if a single month is selected
                let startDay = minDate.getDate();
                let endDay = maxDate.getDate();
                let daysInSelectedMonth = dateDiffInDays(minDate, maxDate);


                for (let i = 0; i < daysInSelectedMonth; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('day-of-month-cell');
                    dayCell.textContent = startDay + i;
                    dayCell.style.width = `${dayWidthPercentage}%`;
                    daysOfMonthRow.appendChild(dayCell);
                }
            }

            const vacationsByEntity = filteredVacations.reduce((acc, vacation) => {
                const entityName = vacation.name;
                if (!acc[entityName]) {
                    acc[entityName] = [];
                }
                acc[entityName].push(vacation);
                return acc;
            }, {});

            const sortedEntities = Object.keys(vacationsByEntity).sort((a, b) => {
                const isR_A = a.startsWith('Р') && a.length > 1 && !isNaN(parseInt(a.substring(1)));
                const isR_B = b.startsWith('Р') && b.length > 1 && !isNaN(parseInt(b.substring(1)));

                if (isR_A && isR_B) {
                    return parseInt(a.substring(1)) - parseInt(b.substring(1));
                }
                if (isR_A) return 1;
                if (isR_B) return -1;
                return a.localeCompare(b);
            });


            sortedEntities.forEach(entityName => {
                const employeeTimeline = document.createElement('div');
                employeeTimeline.classList.add('employee-timeline');

                const nameDiv = document.createElement('div');
                nameDiv.classList.add('employee-name-calendar');
                nameDiv.textContent = entityName;
                employeeTimeline.appendChild(nameDiv);

                const daysContainer = document.createElement('div');
                daysContainer.classList.add('days-container');

                vacationsByEntity[entityName].forEach(vacation => {
                    const vacStart = new Date(vacation.start);
                    const vacEnd = new Date(vacation.end);

                    const displayStart = new Date(Math.max(vacStart.getTime(), minDate.getTime()));
                    const displayEnd = new Date(Math.min(vacEnd.getTime(), maxDate.getTime()));

                    if (displayStart <= displayEnd) {
                        const offsetDays = dateDiffInDays(minDate, displayStart) -1;
                        const durationInView = dateDiffInDays(displayStart, displayEnd);

                        const dayBlock = document.createElement('div');
                        dayBlock.classList.add('day-block');
                        if (vacation.type === 'brigade') {
                            dayBlock.classList.add('brigade');
                        }
                        dayBlock.style.left = `${offsetDays * dayWidthPercentage}%`;
                        dayBlock.style.width = `${durationInView * dayWidthPercentage}%`;
                        if (durationInView * dayWidthPercentage > 5) {
                           dayBlock.textContent = `Отпуск`;
                        }
                        daysContainer.appendChild(dayBlock);
                    }
                });
                employeeTimeline.appendChild(daysContainer);
                timelineView.appendChild(employeeTimeline);
            });
        }


        // --- Обработчики форм и модальных окон ---
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            formError.textContent = '';

            const entityType = entityTypeSelect.value;
            let name = '';

            if (entityType === 'employee') {
                name = officeEmployeeNameSelect.value;
            } else if (entityType === 'brigade') {
                name = brigadeNameSelect.value;
            } else {
                formError.textContent = 'Пожалуйста, выберите тип (Сотрудник офиса или Бригада цеха).';
                return;
            }

            if (!name) {
                 formError.textContent = `Пожалуйста, выберите ${entityType === 'employee' ? 'сотрудника' : 'бригаду'}.`;
                 return;
            }

            const start = form.vacationStart.value;
            const end = form.vacationEnd.value;

            if (!start || !end) {
                formError.textContent = 'Начало и конец отпуска обязательны для заполнения.';
                return;
            }

            const startDate = new Date(start);
            const endDate = new Date(end);

            if (endDate < startDate) {
                formError.textContent = 'Дата окончания отпуска не может быть раньше даты начала.';
                return;
            }
            
            await addVacationToFirestore({ name, start, end, type: entityType });
        });

        // Модальное окно подтверждения отпуска
        closeModalButton.onclick = () => confirmDeleteModal.style.display = 'none';
        cancelDeleteButton.onclick = () => confirmDeleteModal.style.display = 'none';
        confirmDeleteButtonAction.onclick = async function() {
            if (vacationToDeleteId !== null) {
                await deleteVacationFromFirestore(vacationToDeleteId);
                confirmDeleteModal.style.display = 'none';
            }
        };

        // Модальное окно подтверждения сотрудника
        closeEmployeeModalButton.onclick = () => confirmDeleteEmployeeModal.style.display = 'none';
        cancelDeleteEmployeeButton.onclick = () => confirmDeleteEmployeeModal.style.display = 'none';
        confirmDeleteEmployeeButtonAction.onclick = async function() {
            if (employeeToDeleteId !== null) {
                await deleteEmployeeAndTheirVacations(employeeToDeleteId, employeeToDeleteName);
                confirmDeleteEmployeeModal.style.display = 'none';
            }
        };

        // Закрытие модальных окон при клике вне их
        window.onclick = function(event) {
            if (event.target == confirmDeleteModal) {
                confirmDeleteModal.style.display = 'none';
            }
            if (event.target == confirmDeleteEmployeeModal) {
                confirmDeleteEmployeeModal.style.display = 'none';
            }
        };


        // --- Фильтры и экспорт PDF ---
        function populateFilterOptions() {
            const currentMonthValue = filterMonthSelect.value;
            filterMonthSelect.innerHTML = '<option value="">Все месяцы</option>';

            const months = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                filterMonthSelect.appendChild(option);
            });
            filterMonthSelect.value = currentMonthValue;
        }

        function applyAllFilters() {
            const monthFilter = filterMonthSelect.value;
            const yearFilter = filterYearInput.value;

            let filtered = vacations;

            if (yearFilter) {
                filtered = filtered.filter(v => {
                    const startYear = new Date(v.start).getFullYear();
                    const endYear = new Date(v.end).getFullYear();
                    return startYear === parseInt(yearFilter) || endYear === parseInt(yearFilter);
                });
            }

            if (monthFilter !== "") {
                filtered = filtered.filter(v => {
                    const vacStart = new Date(v.start);
                    const vacEnd = new Date(v.end);
                    const filterMonthDateStart = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter), 1);
                    const filterMonthDateEnd = new Date(yearFilter || new Date().getFullYear(), parseInt(monthFilter) + 1, 0);

                    return (vacStart <= filterMonthDateEnd && vacEnd >= filterMonthDateStart);
                });
            }
            renderVacations(filtered);
            renderCalendarView(filtered);
        }

        applyFiltersButton.addEventListener('click', applyAllFilters);

        // Обработчик кнопки экспорта PDF, прикрепленный к window.onload
        window.onload = function() {
            exportPdfButton.addEventListener('click', () => {
                const element = document.getElementById('content-to-export');
                
                // Клонируем элемент, чтобы применить стили для PDF
                const clonedElement = element.cloneNode(true);
                
                // Удаляем элементы, которые не должны быть в PDF (например, формы управления)
                const addOfficeEmployeeFormClone = clonedElement.querySelector('#addOfficeEmployeeForm');
                if (addOfficeEmployeeFormClone) addOfficeEmployeeFormClone.remove();

                const addVacationFormClone = clonedElement.querySelector('#addVacationForm');
                if (addVacationFormClone) addVacationFormClone.remove();

                const filterAndExportSection = clonedElement.querySelector('.mb-6.flex');
                if (filterAndExportSection) filterAndExportSection.remove();

                // Удаляем колонку "Действия" из таблицы (если она есть)
                const tableHeaders = clonedElement.querySelectorAll('#vacationList').length > 0 ? clonedElement.querySelector('#vacationList').parentNode.querySelectorAll('thead th') : [];
                const actionHeaderIndex = Array.from(tableHeaders).findIndex(th => th.textContent.includes('Действия'));
                if (actionHeaderIndex !== -1) {
                    tableHeaders[actionHeaderIndex].remove();
                    clonedElement.querySelectorAll('#vacationList tr').forEach(row => {
                        if (row.children[actionHeaderIndex]) {
                            row.children[actionHeaderIndex].remove();
                        }
                    });
                }

                const options = {
                    margin: [0.5, 0.5, 0.5, 0.5], // top, left, bottom, right
                    filename: 'график_отпусков.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        logging: true,
                        useCORS: true
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
                };

                if (window.html2pdf) {
                    window.html2pdf().set(options).from(clonedElement).save();
                } else {
                    alert('Ошибка: Библиотека html2pdf не загружена. Проверьте подключение к интернету или CDN-ссылку.');
                    console.error('html2pdf is not defined on window.onload');
                }
            });

            // Инициализация при загрузке страницы
            populateFilterOptions();
            const currentYear = new Date().getFullYear();
            filterYearInput.value = currentYear;
            fetchOfficeEmployees();
            fetchVacations();
        };

    </script>
</body>
</html>
